{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <!-- 상단 헤더 및 검색 영역 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI 지식 데이터베이스</h5>
                    <div>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="키워드 검색..." aria-label="Search keywords">
                            <button class="btn btn-primary" type="button">
                                <i class="bx bx-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bx bx-info-circle me-2"></i>
                        AI 지식 데이터베이스는 <strong>기록지식</strong>(과거환경, 병해충, 생육, 수분, 영양 이력과 제어이력)과 <strong>경험지식</strong>(농업경영체의 경험 데이터)을 축적합니다. 이 지식은 더 나은 AI 진단과 처방을 위한 기반이 됩니다.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 지식 좌우 분리 레이아웃 -->
    <div class="row">
        <!-- 왼쪽: 기록지식 -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bx bx-spreadsheet me-1"></i> 기록지식</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">과거 2년 간의 환경, 병해충, 생육, 수분, 영양 이력과 제어이력 데이터를 확인하세요.</p>
                    
                    <!-- 기록지식 필터링 영역 -->
                    <div class="card mb-4 border">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">데이터 필터링</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="region-filter">지역</label>
                                    <select class="form-select form-select-sm" id="region-filter">
                                        <option value="all" selected>전체 지역</option>
                                        <option value="김제지구">김제지구</option>
                                        <option value="태안지구">태안지구</option>
                                        <option value="밀양지구">밀양지구</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="data-type-filter">데이터 유형</label>
                                    <select class="form-select form-select-sm" id="data-type-filter">
                                        <option value="all" selected>전체 유형</option>
                                        <option value="environment">환경 데이터</option>
                                        <option value="pest">병해충 데이터</option>
                                        <option value="growth">생육 데이터</option>
                                        <option value="moisture">수분 데이터</option>
                                        <option value="nutrition">영양 데이터</option>
                                        <option value="control">제어 이력</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="period-filter">기간</label>
                                    <select class="form-select form-select-sm" id="period-filter">
                                        <option value="6month">최근 6개월</option>
                                        <option value="1year">최근 1년</option>
                                        <option value="2year" selected>최근 2년</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="vis-type-filter">시각화 유형</label>
                                    <select class="form-select form-select-sm" id="vis-type-filter">
                                        <option value="line" selected>선 그래프</option>
                                        <option value="bar">막대 그래프</option>
                                        <option value="heatmap">히트맵</option>
                                        <option value="table">테이블</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 text-end">
                                    <button class="btn btn-sm btn-primary" id="apply-record-filter">
                                        <i class="bx bx-filter-alt me-1"></i> 필터 적용
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" id="reset-filter">
                                        <i class="bx bx-reset me-1"></i> 초기화
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 통계 요약 그래프 -->
                    <div class="card mb-4 border">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">데이터 통계 (최근 2년)</h6>
                            <div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bx bx-export me-1"></i> 내보내기
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" id="download-csv">CSV 다운로드</a></li>
                                        <li><a class="dropdown-item" href="#" id="download-excel">Excel 다운로드</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="record-data-visualization" style="height: 350px;"></div>
                        </div>
                    </div>
                    
                    <!-- 데이터 요약 카드 -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-primary bg-opacity-10 text-primary rounded p-2">
                                                <i class="bx bx-line-chart fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">환경 데이터</h6>
                                            <h4 class="mb-0">12,485</h4>
                                            <small class="text-muted">측정 포인트</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-danger bg-opacity-10 text-danger rounded p-2">
                                                <i class="bx bx-bug fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">병해충 데이터</h6>
                                            <h4 class="mb-0">1,843</h4>
                                            <small class="text-muted">탐지 건수</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-warning bg-opacity-10 text-warning rounded p-2">
                                                <i class="bx bx-leaf fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">생육 데이터</h6>
                                            <h4 class="mb-0">589</h4>
                                            <small class="text-muted">측정 기록</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-info bg-opacity-10 text-info rounded p-2">
                                                <i class="bx bx-water fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">수분 데이터</h6>
                                            <h4 class="mb-0">2,456</h4>
                                            <small class="text-muted">측정 기록</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-success bg-opacity-10 text-success rounded p-2">
                                                <i class="bx bx-trending-up fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">영양 데이터</h6>
                                            <h4 class="mb-0">1,782</h4>
                                            <small class="text-muted">측정 기록</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-secondary bg-opacity-10 text-secondary rounded p-2">
                                                <i class="bx bx-droplet fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">관비/관수</h6>
                                            <h4 class="mb-0">3,842</h4>
                                            <small class="text-muted">처리 횟수</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-dark bg-opacity-10 text-dark rounded p-2">
                                                <i class="bx bx-vial fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">약재살포</h6>
                                            <h4 class="mb-0">1,254</h4>
                                            <small class="text-muted">처리 횟수</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border h-100">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <span class="bg-primary bg-opacity-10 text-primary rounded p-2">
                                                <i class="bx bx-cog fs-4"></i>
                                            </span>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="mb-1">제어 이력</h6>
                                            <h4 class="mb-0">3,651</h4>
                                            <small class="text-muted">총 제어 건수</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 기록지식 시계열 데이터 테이블 -->
                    <div class="card border">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">기록지식 상세 데이터</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bx bx-download me-1"></i> 다운로드
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="download-table-csv">CSV</a></li>
                                    <li><a class="dropdown-item" href="#" id="download-table-excel">Excel</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th scope="col">ID</th>
                                            <th scope="col">유형</th>
                                            <th scope="col">측정값</th>
                                            <th scope="col">지역</th>
                                            <th scope="col">측정시간</th>
                                            <th scope="col">조치</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th scope="row">ENV8765</th>
                                            <td><span class="badge bg-primary">환경</span></td>
                                            <td>온도: 32.5°C, 습도: 78%</td>
                                            <td>김제지구</td>
                                            <td>2023-07-10 14:30</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">보기</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row">PEST562</th>
                                            <td><span class="badge bg-danger">병해충</span></td>
                                            <td>진딧물 발생, 심각도: 3/5</td>
                                            <td>태안지구</td>
                                            <td>2023-07-09 10:15</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">보기</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row">CTL4532</th>
                                            <td><span class="badge bg-secondary">제어</span></td>
                                            <td>자동 관수 시스템, 30분간 작동</td>
                                            <td>김제지구</td>
                                            <td>2023-07-08 08:00</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">보기</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row">GRW2291</th>
                                            <td><span class="badge bg-warning">생육</span></td>
                                            <td>잎 크기: 8.2cm, NDVI: 0.76</td>
                                            <td>태안지구</td>
                                            <td>2023-07-07 15:45</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">보기</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row">MOIST342</th>
                                            <td><span class="badge bg-info">수분</span></td>
                                            <td>토양 수분: 35%, 강수량: 0mm</td>
                                            <td>밀양지구</td>
                                            <td>2023-07-06 09:20</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">보기</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                                <div>
                                    <p class="text-muted mb-0">총 22,806개 항목 중 1-5 표시</p>
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 오른쪽: 경험지식 -->
        <div class="col-md-5">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bx bx-brain me-1"></i> 경험지식</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">농업경영체의 경험과 노하우를 공유하고 관리합니다.</p>
                    
                    <!-- 경험지식 필터링 영역 -->
                    <div class="card mb-4 border">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">경험지식 필터링</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">지역</label>
                                    <select class="form-select form-select-sm">
                                        <option value="all" selected>전체 지역</option>
                                        <option value="gimje">김제지구</option>
                                        <option value="taean">태안지구</option>
                                        <option value="miryang">밀양지구</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">카테고리</label>
                                    <select class="form-select form-select-sm">
                                        <option value="all" selected>전체 카테고리</option>
                                        <option value="water">수분 관리</option>
                                        <option value="pest">병해충 관리</option>
                                        <option value="nutrition">영양 관리</option>
                                        <option value="environment">환경 조절</option>
                                        <option value="harvest">수확 관리</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">기간</label>
                                    <select class="form-select form-select-sm">
                                        <option value="all" selected>전체 기간</option>
                                        <option value="month">최근 1개월</option>
                                        <option value="year">최근 1년</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">정렬 기준</label>
                                    <select class="form-select form-select-sm">
                                        <option value="date_desc" selected>최신순</option>
                                        <option value="date_asc">오래된순</option>
                                        <option value="relevance">관련성순</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 text-end">
                                    <button class="btn btn-sm btn-primary" id="apply-experience-filter">
                                        <i class="bx bx-filter-alt me-1"></i> 필터 적용
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-2">
                                        <i class="bx bx-reset me-1"></i> 초기화
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 경험지식 목록 - 위치 변경됨 -->
                    <div class="card mb-4 border">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">최근 경험지식</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="bx bx-export me-1"></i> 전체보기
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6 class="mb-0">개화기 때 개미 발생 시 자연 방제법</h6>
                                        <span class="badge bg-info">수분 관리</span>
                                    </div>
                                    <p class="mb-2 small">개화기에 식물의 밀원으로 인해 개미가 발생하는 경우, 유기농 재배에 적합한 자연 방제법으로 계피가루나 식초 희석액을 활용할 수 있습니다...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted small">
                                            <i class="bx bx-map-pin me-1"></i> 김제지구
                                            <i class="bx bx-calendar ms-3 me-1"></i> 2023-07-12
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary">자세히</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="list-group-item p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6 class="mb-0">비 온 후 질소 비료 공급 시기 최적화</h6>
                                        <span class="badge bg-info">영양 관리</span>
                                    </div>
                                    <p class="mb-2 small">장마철 이후 질소 비료를 시비할 때는 토양이 충분히 마른 후에 적용하는 것이 좋습니다. 너무 습한 상태에서 질소 비료를 공급하면 유실되거나...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted small">
                                            <i class="bx bx-map-pin me-1"></i> 전체 지역
                                            <i class="bx bx-calendar ms-3 me-1"></i> 2023-07-05
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary">자세히</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="list-group-item p-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6 class="mb-0">고온기 콩 생육 관리 경험</h6>
                                        <span class="badge bg-info">환경 조절</span>
                                    </div>
                                    <p class="mb-2 small">7-8월 고온기에는 오전 9시 이전 또는 오후 5시 이후에 관수하는 것이 효과적입니다. 한낮 관수는 증발량이 많고 고온과 결합하여 잎 화상을...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted small">
                                            <i class="bx bx-map-pin me-1"></i> 밀양지구
                                            <i class="bx bx-calendar ms-3 me-1"></i> 2023-06-28
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary">자세히</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white text-center">
                            <a href="#" class="text-decoration-none">더 많은 경험지식 보기</a>
                        </div>
                    </div>
                    
                    <!-- 경험지식 추가 - 위치 변경됨 -->
                    <div class="card border">
                        <div class="card-header bg-white">
                            <h6 class="mb-0">새 경험지식 추가하기</h6>
                        </div>
                        <div class="card-body">
                            <form>
                                <div class="mb-3">
                                    <label for="knowledgeTitle" class="form-label">제목</label>
                                    <input type="text" class="form-control form-control-sm" id="knowledgeTitle" placeholder="지식의 제목을 입력하세요">
                                </div>
                                <div class="mb-3">
                                    <label for="knowledgeCategory" class="form-label">카테고리</label>
                                    <select class="form-select form-select-sm" id="knowledgeCategory">
                                        <option selected>카테고리 선택</option>
                                        <option>수분 관리</option>
                                        <option>병해충 관리</option>
                                        <option>영양 관리</option>
                                        <option>환경 조절</option>
                                        <option>수확 관리</option>
                                        <option>기타</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="knowledgeContent" class="form-label">내용</label>
                                    <textarea class="form-control form-control-sm" id="knowledgeContent" rows="4" placeholder="귀하의 경험과 지식을 상세히 기술해주세요"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="knowledgeRegion" class="form-label">관련 지역</label>
                                        <select class="form-select form-select-sm" id="knowledgeRegion">
                                            <option selected>전체 지역</option>
                                            <option>김제지구</option>
                                            <option>태안지구</option>
                                            <option>밀양지구</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="knowledgeMedia" class="form-label">미디어 첨부</label>
                                        <input class="form-control form-control-sm" type="file" id="knowledgeMedia">
                                    </div>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="agreeTerms">
                                    <label class="form-check-label" for="agreeTerms">본 지식을 AI 학습 데이터로 활용하는 것에 동의합니다.</label>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="bx bx-share-alt me-1"></i> 지식 공유하기
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 관리자용 데이터 관리 모달 -->
    <div class="modal fade" id="dataManagementModal" tabindex="-1" aria-labelledby="dataManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dataManagementModalLabel">Parquet 데이터 관리</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>DuckDB/Parquet 데이터를 생성하거나 관리할 수 있습니다.</p>
                    
                    <div class="mb-3">
                        <label for="data-days" class="form-label">생성할 데이터 기간 (일)</label>
                        <input type="number" class="form-control" id="data-days" value="730" min="30" max="1825">
                        <div class="form-text">생성할 과거 데이터의 기간 (최소 30일, 최대 5년)</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bx bx-info-circle me-2"></i>
                        데이터 생성 시 기존 데이터가 있으면 추가됩니다. 데이터 생성에는 시간이 소요될 수 있습니다.
                    </div>
                    
                    <div id="data-generation-status"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="generate-data-btn">
                        <i class="bx bx-data me-1"></i> 데이터 생성
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ApexCharts 라이브러리 - 명시적 버전 지정 -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 전역 변수
        let mainChart = null;
        
        // API에서 기록지식 데이터 가져오기
        function fetchRecordKnowledgeData() {
            // 필터 값 가져오기
            const region = document.getElementById('region-filter').value;
            const dataType = document.getElementById('data-type-filter').value;
            const period = document.getElementById('period-filter').value;
            
            // 로딩 표시
            document.getElementById('record-data-visualization').innerHTML = 
                '<div class="d-flex justify-content-center align-items-center" style="height: 350px;">' +
                '<div class="spinner-border text-primary" role="status">' +
                '<span class="visually-hidden">로딩 중...</span></div>' +
                '<span class="ms-2">DuckDB에서 데이터를 불러오는 중...</span></div>';
            
            // API 호출
            fetch(`/api/data/record-knowledge?region=${region}&type=${dataType}&period=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 요약 통계 업데이트
                        updateSummaryCards(data.summary);
                        
                        // 차트 데이터 렌더링
                        renderRecordKnowledgeChart(data.data);
                        
                        // 상세 데이터 테이블 업데이트
                        fetchRecordKnowledgeDetails();
                    } else {
                        console.error('데이터 로드 실패:', data.error);
                        document.getElementById('record-data-visualization').innerHTML = 
                            '<div class="alert alert-danger">데이터 로드 중 오류가 발생했습니다.</div>';
                    }
                })
                .catch(error => {
                    console.error('API 호출 실패:', error);
                    document.getElementById('record-data-visualization').innerHTML = 
                        '<div class="alert alert-danger">서버에 연결할 수 없습니다.</div>';
                });
        }
        
        // 요약 카드 업데이트
        function updateSummaryCards(summary) {
            // 각 요약 카드의 숫자 업데이트
            if (summary) {
                document.querySelector('.card:has(.bx-line-chart) h4').textContent = summary.environment_count.toLocaleString();
                document.querySelector('.card:has(.bx-bug) h4').textContent = summary.pest_count.toLocaleString();
                document.querySelector('.card:has(.bx-leaf) h4').textContent = summary.growth_count.toLocaleString();
                document.querySelector('.card:has(.bx-water) h4').textContent = summary.moisture_count.toLocaleString();
                document.querySelector('.card:has(.bx-trending-up) h4').textContent = summary.nutrition_count.toLocaleString();
                document.querySelector('.card:has(.bx-droplet) h4').textContent = summary.irrigation_count.toLocaleString();
                document.querySelector('.card:has(.bx-vial) h4').textContent = summary.pesticide_count.toLocaleString();
                document.querySelector('.card:has(.bx-cog) h4').textContent = summary.control_count.toLocaleString();
            }
        }
        
        // 상세 데이터 테이블 업데이트
        function fetchRecordKnowledgeDetails(page = 1) {
            // 필터 값 가져오기
            const region = document.getElementById('region-filter').value;
            const dataType = document.getElementById('data-type-filter').value;
            
            // API 호출
            fetch(`/api/data/record-knowledge/details?region=${region}&type=${dataType}&page=${page}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateDataTable(data.data, data.pagination);
                    } else {
                        console.error('상세 데이터 로드 실패:', data.error);
                    }
                })
                .catch(error => {
                    console.error('API 호출 실패:', error);
                });
        }
        
        // 데이터 테이블 업데이트
        function updateDataTable(items, pagination) {
            const tableBody = document.querySelector('.table-hover tbody');
            
            // 테이블 내용 초기화
            tableBody.innerHTML = '';
            
            // 새 데이터로 테이블 채우기
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <th scope="row">${item.id}</th>
                    <td><span class="badge bg-${getBadgeColor(item.type)}">${item.type_kr}</span></td>
                    <td>${item.value}</td>
                    <td>${item.region}</td>
                    <td>${item.timestamp}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary">보기</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // 페이지네이션 정보 업데이트
            const paginationInfo = document.querySelector('.text-muted.mb-0');
            paginationInfo.textContent = `총 ${pagination.total_items.toLocaleString()}개 항목 중 ${(pagination.page-1)*pagination.per_page+1}-${Math.min(pagination.page*pagination.per_page, pagination.total_items)} 표시`;
            
            // 페이지 링크 업데이트
            updatePagination(pagination);
        }
        
        // 페이지네이션 업데이트
        function updatePagination(pagination) {
            const paginationList = document.querySelector('.pagination');
            paginationList.innerHTML = '';
            
            // 이전 버튼
            const prevItem = document.createElement('li');
            prevItem.className = `page-item ${pagination.page <= 1 ? 'disabled' : ''}`;
            prevItem.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous" ${pagination.page > 1 ? 'data-page="' + (pagination.page - 1) + '"' : ''}>
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            paginationList.appendChild(prevItem);
            
            // 페이지 번호
            for (let i = 1; i <= Math.min(pagination.total_pages, 5); i++) {
                const pageItem = document.createElement('li');
                pageItem.className = `page-item ${pagination.page === i ? 'active' : ''}`;
                pageItem.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                paginationList.appendChild(pageItem);
            }
            
            // 다음 버튼
            const nextItem = document.createElement('li');
            nextItem.className = `page-item ${pagination.page >= pagination.total_pages ? 'disabled' : ''}`;
            nextItem.innerHTML = `
                <a class="page-link" href="#" aria-label="Next" ${pagination.page < pagination.total_pages ? 'data-page="' + (pagination.page + 1) + '"' : ''}>
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            paginationList.appendChild(nextItem);
            
            // 페이지 클릭 이벤트 연결
            document.querySelectorAll('.pagination .page-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    fetchRecordKnowledgeDetails(page);
                });
            });
        }
        
        // 배지 색상 가져오기
        function getBadgeColor(type) {
            const colors = {
                'environment': 'primary',
                'pest': 'danger',
                'growth': 'warning',
                'moisture': 'info',
                'nutrition': 'success',
                'control': 'secondary'
            };
            return colors[type] || 'primary';
        }
        
        // 메인 데이터 차트 렌더링
        function renderRecordKnowledgeChart(data) {
            // 차트 옵션 설정
            const chartOptions = {
                series: [
                    {
                        name: '온도 (°C)',
                        data: data.temperature || []
                    },
                    {
                        name: '습도 (%)',
                        data: data.humidity || []
                    },
                    {
                        name: 'NDVI',
                        data: data.ndvi || []
                    },
                    {
                        name: '토양 수분 (%)',
                        data: data.soil_moisture || []
                    },
                    {
                        name: '영양 상태 (NPK 지수)',
                        data: data.nutrition || []
                    },
                    {
                        name: '병해충 발생 (건수)',
                        data: data.pest_occurrence || [],
                        type: 'column'
                    },
                    {
                        name: '관비/관수/약재살포 (횟수)',
                        data: data.treatment_frequency || [],
                        type: 'column'
                    }
                ],
                chart: {
                    height: 350,
                    type: 'line',
                    toolbar: {
                        show: true
                    },
                    animations: {
                        enabled: false // 성능 향상을 위해 애니메이션 비활성화
                    }
                },
                stroke: {
                    width: [2, 2, 2, 2, 2, 0, 0],
                    curve: 'smooth',
                    dashArray: [0, 0, 0, 3, 3, 0, 0]
                },
                colors: ['#FF9800', '#2196F3', '#4CAF50', '#00BCD4', '#9C27B0', '#F44336', '#795548'],
                dataLabels: {
                    enabled: false
                },
                title: {
                    text: '최근 농업 데이터 (DuckDB/Parquet 기반)',
                    align: 'left'
                },
                xaxis: {
                    categories: data.timestamps || [],
                    labels: {
                        rotate: -45,
                        style: {
                            fontSize: '10px'
                        }
                    }
                },
                yaxis: [
                    {
                        title: {
                            text: '측정값'
                        },
                        forceNiceScale: true
                    },
                    {
                        opposite: true,
                        title: {
                            text: '발생/처리 횟수'
                        },
                        min: 0,
                        max: 15,
                        forceNiceScale: true
                    }
                ],
                tooltip: {
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function (y, { series, seriesIndex, dataPointIndex, w }) {
                            if (seriesIndex === 0) return y.toFixed(1) + ' °C';
                            if (seriesIndex === 1) return y.toFixed(1) + ' %';
                            if (seriesIndex === 2) return y.toFixed(2);
                            if (seriesIndex === 3) return y.toFixed(1) + ' %';
                            if (seriesIndex === 4) return y.toFixed(0);
                            if (seriesIndex === 5 || seriesIndex === 6) return y.toFixed(0) + ' 건';
                            return y;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'center',
                    offsetY: 5
                },
                grid: {
                    borderColor: '#e0e0e0',
                    row: {
                        colors: ['#f5f5f5', 'transparent'],
                        opacity: 0.5
                    }
                },
                markers: {
                    size: 3
                },
                responsive: [
                    {
                        breakpoint: 768,
                        options: {
                            chart: {
                                height: 300
                            },
                            legend: {
                                position: 'bottom',
                                offsetY: 0
                            }
                        }
                    }
                ]
            };

            try {
                console.log('메인 차트 렌더링 시작...');
                const element = document.querySelector("#record-data-visualization");
                if (!element) {
                    console.error('차트 컨테이너를 찾을 수 없습니다: #record-data-visualization');
                    return;
                }
                
                // 컨테이너 초기화
                element.innerHTML = '';
                element.style.minHeight = '350px';

                // 기존 차트가 있으면 먼저 제거
                if (mainChart) {
                    mainChart.destroy();
                }

                // 새 차트 인스턴스 생성 및 렌더링
                mainChart = new ApexCharts(element, chartOptions);
                mainChart.render().then(() => {
                    console.log('메인 차트 렌더링 완료');
                }).catch(error => {
                    console.error('메인 차트 렌더링 오류:', error);
                });
            } catch (e) {
                console.error('메인 차트 초기화 오류:', e);
            }
        }
        
        // 데이터 다운로드 함수
        function downloadData(format) {
            const region = document.getElementById('region-filter').value;
            const dataType = document.getElementById('data-type-filter').value;
            const period = document.getElementById('period-filter').value;
            
            window.location.href = `/api/data/record-knowledge/download?format=${format}&region=${region}&type=${dataType}&period=${period}`;
        }
        
        // Parquet 데이터 생성 함수
        function generateParquetData() {
            const days = document.getElementById('data-days').value;
            const statusElement = document.getElementById('data-generation-status');
            
            // 상태 업데이트
            statusElement.innerHTML = `
                <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <div>데이터를 생성하는 중입니다. 잠시만 기다려주세요...</div>
                    </div>
                </div>
            `;
            
            // API 호출
            fetch(`/api/data/generate-parquet?days=${days}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusElement.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bx bx-check-circle me-2"></i> ${data.message}
                        </div>
                    `;
                    
                    // 데이터 다시 로드
                    setTimeout(() => {
                        fetchRecordKnowledgeData();
                    }, 1000);
                } else {
                    statusElement.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bx bx-error-circle me-2"></i> ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                statusElement.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bx bx-error-circle me-2"></i> 서버 연결 오류
                    </div>
                `;
                console.error('데이터 생성 오류:', error);
            });
        }

        // 필터 버튼 클릭 이벤트
        document.getElementById('apply-record-filter').addEventListener('click', function() {
            fetchRecordKnowledgeData();
        });
        
        // 필터 초기화 버튼
        document.getElementById('reset-filter').addEventListener('click', function() {
            document.getElementById('region-filter').value = 'all';
            document.getElementById('data-type-filter').value = 'all';
            document.getElementById('period-filter').value = '2year';
            document.getElementById('vis-type-filter').value = 'line';
            fetchRecordKnowledgeData();
        });
        
        // CSV 다운로드 버튼
        document.getElementById('download-csv').addEventListener('click', function(e) {
            e.preventDefault();
            downloadData('csv');
        });
        
        // Excel 다운로드 버튼
        document.getElementById('download-excel').addEventListener('click', function(e) {
            e.preventDefault();
            downloadData('excel');
        });
        
        // 테이블 데이터 CSV 다운로드
        document.getElementById('download-table-csv').addEventListener('click', function(e) {
            e.preventDefault();
            downloadData('csv');
        });
        
        // 테이블 데이터 Excel 다운로드
        document.getElementById('download-table-excel').addEventListener('click', function(e) {
            e.preventDefault();
            downloadData('excel');
        });
        
        // 데이터 생성 버튼
        document.getElementById('generate-data-btn').addEventListener('click', function() {
            generateParquetData();
        });
        
        // 키보드 단축키: Ctrl+Alt+D = 데이터 관리 모달 열기
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.altKey && e.key === 'd') {
                const dataModal = new bootstrap.Modal(document.getElementById('dataManagementModal'));
                dataModal.show();
            }
        });
        
        document.getElementById('apply-experience-filter').addEventListener('click', function() {
            alert('경험지식 필터가 적용되었습니다.');
        });
        
        // 초기 데이터 로드
        fetchRecordKnowledgeData();
    });
</script>
{% endblock %} 